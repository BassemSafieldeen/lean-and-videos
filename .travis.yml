dist: xenial # required for Python >= 3.7
language: python
python:
  - "3.7"
sudo: false
os:
    - linux
branches:
  only:
    - ui

env:
  global:
    secure: "WDJfE00W9Od0kZU3wJpXVs0cJrOuoNQjmIBZgXcLrQJBDYwdegqWAFbQTixYZBDFri8fvBHT5WNHOp88DW+q6zboiCY2C5omhcOHEqRfBxq089IxA34sF9HNXPyYCOxjHphZ9AHDJQP65KeUK7b8Gg2Wz8rFTCeth2T19hZC99mtpdeRUBE1xkxrUuu8csV1C/OcUdfPq+cufynyExrxWI3HZAICykU5CbCBfBvrbVH9gVrhvshHjc0NK6H5jfjmEdizxHSXs+i4uWk+CdxKbRS1LZqMD2GZq7yczowz1yZwpRdCT5UbXF6j90Bm5I+idUPH9u1ALAB3mNt6TBjyMeIo6QOv+scaGD75P3FDnwe6hQ1XcD1iLBNLCYtxyglgyht5loKrD++WTEowyHGQeQLekWpqen+VYVi0yIdkfCHCdSFDX7Z56nUc7n8pwJ+aLABgbIxhSpIOb4uLkk56MZzrYnszVDPlnUBjLsQaVZWCnEp6BiqeFeJVHl0546E5pF0ptaF8CJZ8urzaHzuFnHQwLLVOP28rlAn1Qgy9sYPHhtTS6PJ46yWghIvBZPzXsa0QHhg9pnM8CgJp5kVY4H+rr7687edv1sst24pnKl2tbDm3YzOc0nLdkx9JvS7qurBRiXLvzdkeLNYfiHySgmnh66JSNmzKu3e683SkuQY="
cache:
  directories:
    - $TRAVIS_BUILD_DIR/combined_lib_cache/
    - $TRAVIS_BUILD_DIR/lean-fibonacci/
    - $TRAVIS_BUILD_DIR/dist/
    - $HOME/.elan

install:
  - |
    if [ ! -d "$HOME/.elan/toolchains/" ]; then
      curl https://raw.githubusercontent.com/Kha/elan/master/elan-init.sh -sSf | sh -s -- --default-toolchain none -y
    fi
  - |
    if [ ! -e "$TRAVIS_BUILD_DIR/combined_lib_cache/leanpkg.toml" ]; then
      cp -av combined_lib/. combined_lib_cache
    fi
  - |
    if [ ! -e "$TRAVIS_BUILD_DIR/lean-fibonacci/leanpkg.toml" ]; then
      git clone https://github.com/bryangingechen/lean-fibonacci.git
    fi
  - source ~/.elan/env
  - source elan_setup.sh
  - mkdir $HOME/scripts || echo ""
  - export PATH="$HOME/scripts:$PATH"
  - cp travis_long.sh $HOME/scripts/travis_long
  - chmod +x $HOME/scripts/travis_long

jobs:
  include:
    - stage: Build-1
      script:
        - |
          if [ $TRAVIS_EVENT_TYPE == 'cron' ]; then
            find . -name *.olean -delete
          fi
        - elan override set leanprover-community/lean:$LATEST_BROWSER_LEAN
        - travis_long "./mk_library.py -c -o dist/libcore.zip"
        - cd combined_lib_cache
        - elan override set leanprover-community/lean:$LATEST_BROWSER_LEAN
        - leanpkg upgrade
        - rm -rf _target/deps/mathlib/test
        - rm -rf _target/deps/mathlib/scripts
        - rm -rf _target/deps/mathlib/roadmap
        - cd ..
        - travis_long "timeout 2400 ./mk_library.py -i combined_lib_cache" | python detect_errors.py

    - stage: Build-2a
      script:
        - travis_long "timeout 2400 ./mk_library.py -i combined_lib_cache" | python detect_errors.py

    - stage: Build-2b
      script:
        - travis_long "timeout 2400 ./mk_library.py -i combined_lib_cache" | python detect_errors.py

    - stage: Build-3
      script:
        - travis_long "./mk_library.py -i combined_lib_cache"
        # make sure we use the same version of Lean that we started with in "Build-1"
        - cd combined_lib_cache
        - ELAN_OVERRIDE=$(lean -v | cut -d ',' -f1 | cut -d ' ' -f3)
        - cd ../lean-fibonacci
        - elan override set leanprover-community/lean:$ELAN_OVERRIDE
        - git pull
        - cd ..
        - travis_long "./mk_library.py -i lean-fibonacci -o dist/libfib.zip"

    - stage: Deploy
      script:
        # make sure we use the same version of Lean that we started with in "Build-1"
        - cd combined_lib_cache
        - export ELAN_OVERRIDE=$(lean -v | cut -d ',' -f1 | cut -d ' ' -f3)
        - cd ..
        - rm -rf .git
        - sh deploy.sh
